<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin Lite Plus — Importación por Partes</title>
<style>
:root{--b:#0b5fff;--ok:#0a8f3c;--err:#c62828;--bg:#fafbff;--card:#fff}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;color:#222}
header{background:var(--b);color:#fff;padding:14px 18px;display:flex;align-items:center;justify-content:space-between}
header h1{font-size:18px;margin:0}
main{max-width:1100px;margin:20px auto;padding:0 16px}
.card{background:var(--card);border-radius:12px;box-shadow:0 8px 28px rgba(11,30,80,.08);padding:16px;margin-bottom:16px}
.row{display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin:8px 0}
input[type="text"],input[type="number"],input[type="password"],input[type="url"]{padding:8px 10px;border:1px solid #d1d5db;border-radius:8px;min-width:180px}
input[type="file"]{padding:6px 0}
button{border:0;border-radius:10px;padding:10px 14px;background:var(--b);color:#fff;font-weight:600;cursor:pointer}
button.secondary{background:#e5e7eb;color:#111}
button.ghost{background:transparent;border:1px solid #d1d5db;color:#333}
button:disabled{opacity:.5;cursor:not-allowed}
table{width:100%;border-collapse:collapse}
th,td{font-size:13px;border-bottom:1px solid #eee;padding:8px;text-align:left}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;font-weight:700;font-size:11px}
.badge.ok{background:#e8f5e9;color:var(--ok)}
.badge.err{background:#ffebee;color:var(--err)}
.mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
</style>
</head>
<body>
<header><h1>Admin Lite Plus · Importación por Partes</h1></header>
<main>
  <div class="card">
    <h3>Conexión</h3>
    <div class="row">
      <div style="display:flex;align-items:center;gap:8px">
        <span id="connDot" style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#cbd5e1"></span>
        <small id="connText" class="mono">Desconectado</small>
      </div>
      <label>API Base</label>
      <input id="apiBase" type="url" placeholder="https://backend-spainroom.onrender.com" />
       <button class="ghost" onclick="probarConexion()">Probar conexión</button>
      <button class="ghost" onclick="probarClave()">Probar clave admin</button>
      <label>Admin Key</label>
      <input id="adminKey" type="password" placeholder="********" />
    </div>
  </div>

  <div class="card">
    <h3>Archivo CSV</h3>
    <div class="row">
      <input type="file" id="csvfile" accept=".csv" />
      <label>Tamaño de parte</label>
      <input type="number" id="chunkSize" value="500" min="100" step="100" />
      <label>Espera entre partes (ms)</label>
      <input type="number" id="throttleMs" value="300" min="0" step="50" />
    </div>
    <div class="row">
      <button onclick="subirDirecto()">Subir directo</button>
      <button onclick="subirEnPartes()">Subir en partes</button>
      <button class="ghost" onclick="reintentarFallidas()">Reintentar fallidas</button>
    </div>
    <div class="row">
      <small>Consejo: usa partes de 500. Si un trozo falla, aparecerá en la tabla y podrás reintentarlo de forma individual.</small>
    </div>
  </div>

  <div class="card">
    <h3>Progreso</h3>
    <div class="row">
      <div style="flex:1;min-width:260px">
        <div style="height:10px;background:#e5e7eb;border-radius:999px;overflow:hidden">
          <div id="bar" style="height:100%;width:0%;background:#0b5fff;transition:width .2s ease"></div>
        </div>
        <div class="row" style="justify-content:space-between;margin-top:6px">
          <small id="pct">0%</small>
          <small id="counter">0 / 0</small>
        </div>
      </div>
      <div style="min-width:200px">
        <small><strong>Totales sesión:</strong></small><br/>
        <small>Insertados: <span id="tIns" class="mono">0</span></small><br/>
        <small>Actualizados: <span id="tUpd" class="mono">0</span></small><br/>
        <small>Errores: <span id="tErr" class="mono">0</span></small>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>Resultado</h3>
    <table>
      <thead>
        <tr><th>#</th><th>Estado</th><th>Insert.</th><th>Actual.</th><th>Errores</th><th>Mensaje</th><th>Acción</th></tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</main>

<script>

function _setConn(state, text){
  const dot = document.getElementById('connDot');
  const t = document.getElementById('connText');
  if(state==='ok'){ dot.style.background = '#0a8f3c'; t.textContent = text || 'Conectado'; }
  else if(state==='warn'){ dot.style.background = '#f59e0b'; t.textContent = text || 'Parcial'; }
  else{ dot.style.background = '#c62828'; t.textContent = text || 'Error de conexión'; }
}
async function _tryGet(url){
  try{
    const r = await fetch(url, { method:'GET', cache:'no-store' });
    if(!r.ok) return {ok:false, status:r.status, text:await r.text()};
    let j=null; const tx = await r.text(); try{ j=JSON.parse(tx) }catch(e){}
    return {ok:true, status:r.status, json:j, text:tx};
  }catch(e){ return {ok:false, status:0, text:String(e)}; }
}
async function probarConexion(){
  const base = api();
  if(!base){ alert('Escribe la API Base'); return; }
  // Probar varias rutas habituales
  const candidates = ['/api/admin/health','/api/health','/health','/version','/'];
  let anyOk = null, details=[];
  for(const p of candidates){
    const url = base + p;
    const res = await _tryGet(url);
    details.push({p, ok:res.ok, status:res.status});
    if(res.ok){ anyOk = res; break; }
  }
  if(anyOk){
    _setConn('ok','Conectado (público)');
  }else{
    _setConn('err','Sin conexión');
  }
  console.log('Ping público:', details);
}
async function probarClave(){
  const base = api(); const k = key();
  if(!base){ alert('Escribe la API Base'); return; }
  if(!k){ alert('Escribe la Admin Key'); return; }
  // Endpoint admin típico (ajusta si hace falta)
  const url = base + '/api/admin/ping';
  try{
    const r = await fetch(url, { method:'GET', headers:{'X-Admin-Key': k}, cache:'no-store' });
    const tx = await r.text(); let j=null; try{ j=JSON.parse(tx) }catch(e){}
    if(r.ok){
      _setConn('ok','Conectado (admin)');
    }else if(r.status===401 || r.status===403){
      _setConn('warn','Clave inválida');
    }else{
      _setConn('err','Admin ping error ' + r.status);
    }
    console.log('Ping admin:', r.status, j||tx);
  }catch(e){
    _setConn('err','Error de red');
  }
}


let _TOTAL_PARTS = 0, _DONE_PARTS = 0;
let _T_INS = 0, _T_UPD = 0, _T_ERR = 0;
function _setProgress(done, total){
  _DONE_PARTS = done; _TOTAL_PARTS = total;
  const pct = total>0 ? Math.round(done*100/total) : 0;
  const bar = document.getElementById('bar');
  const pctEl = document.getElementById('pct');
  const cntEl = document.getElementById('counter');
  if(bar){ bar.style.width = pct + '%'; }
  if(pctEl){ pctEl.textContent = pct + '%'; }
  if(cntEl){ cntEl.textContent = done + ' / ' + total; }
}
function _accTotals(res){
  _T_INS += (res.inserted||0);
  _T_UPD += (res.updated||0);
  _T_ERR += (res.errors||0);
  const tIns = document.getElementById('tIns');
  const tUpd = document.getElementById('tUpd');
  const tErr = document.getElementById('tErr');
  if(tIns) tIns.textContent = _T_INS;
  if(tUpd) tUpd.textContent = _T_UPD;
  if(tErr) tErr.textContent = _T_ERR;
}

function val(id){return document.getElementById(id).value}
function api(){return (val('apiBase')||'').replace(/\\/$/,'')}
function key(){return val('adminKey')}

function appendRow(idx, data){
  const tb=document.getElementById('tbody');
  let tr=document.querySelector('tr[data-idx="'+idx+'"]');
  if(!tr){
    tr=document.createElement('tr');
    tr.dataset.idx=idx;
    tr.innerHTML='<td class="mono">'+idx+'</td>'
      +'<td class="mono status"></td>'
      +'<td class="mono ins"></td>'
      +'<td class="mono upd"></td>'
      +'<td class="mono errs"></td>'
      +'<td class="mono msg"></td>'
      +'<td><button class="ghost mono" onclick="reintentarUno('+idx+')">Reintentar</button></td>';
    tb.appendChild(tr);
  }
  tr.querySelector('.status').innerHTML = data.ok ? '<span class="badge ok">OK</span>' : '<span class="badge err">FALLO</span>';
  tr.querySelector('.ins').textContent = data.inserted ?? '';
  tr.querySelector('.upd').textContent = data.updated ?? '';
  tr.querySelector('.errs').textContent = data.errors ?? '';
  tr.querySelector('.msg').textContent = (data.message||'').slice(0,160);
}

async function postCSV(blob){
  const fd=new FormData(); fd.append('file', blob, 'municipios.csv');
  const r=await fetch(api()+'/api/admin/franquicia/ingest', { method:'POST', headers:{'X-Admin-Key': key()}, body: fd });
  const text = await r.text();
  let j=null; try{ j=JSON.parse(text) }catch(e){}
  if(r.ok && j && (j.ok===true || j.ok==="true")) return {ok:true, inserted:j.inserted||0, updated:j.updated||0, errors:j.errors||0, message:""};
  return {ok:false, inserted:j?.inserted||0, updated:j?.updated||0, errors:j?.errors||0, message:(j?.error || text)};
}

async function subirDirecto(){
  _T_INS=0;_T_UPD=0;_T_ERR=0;_setProgress(0,0);
  const f=document.getElementById('csvfile').files[0];
  if(!f){ alert('Selecciona un CSV'); return; }
  _setProgress(0,1);
  const res=await postCSV(f);
  appendRow('ALL', res);
  _accTotals(res);
  _setProgress(1,1);
}

let LAST_HEADER=null, LAST_ROWS=[], LAST_CHUNK=500, FALLIDAS=new Set();

function csvParse(text){
  const lines=text.split(/\\r?\\n/);
  const header=lines.shift();
  const rows=lines.filter(x=>x.trim()!=="");
  return [header, rows];
}

function makeBlob(header, rows, idx){
  const csv = [header, ...rows].join('\\n');
  return new Blob([csv], {type:'text/csv'});
}

async function subirEnPartes(){
  _T_INS=0;_T_UPD=0;_T_ERR=0;_setProgress(0,0);
  const f=document.getElementById('csvfile').files[0];
  if(!f){ alert('Selecciona un CSV'); return; }
  const t = await f.text();
  const [header, rows] = csvParse(t);
  LAST_HEADER = header; LAST_ROWS = rows;
  const chunk = parseInt(document.getElementById('chunkSize').value)||500;
  LAST_CHUNK = chunk;
  FALLIDAS.clear();
  document.getElementById('tbody').innerHTML='';

  const throttle = parseInt(document.getElementById('throttleMs').value)||0;
  let part=1;
  const totalParts = Math.ceil(rows.length / chunk);
  _setProgress(0, totalParts);
  for(let i=0; i<rows.length; i+=chunk){
    const slice = rows.slice(i, i+chunk);
    const blob = makeBlob(header, slice, part);
    const res = await postCSV(blob);
    appendRow(part, res);
    _accTotals(res);
    _setProgress(part, totalParts);
    if(!res.ok) FALLIDAS.add(part);
    part++;
    if(throttle>0) await new Promise(r=>setTimeout(r, throttle));
  }
  if(FALLIDAS.size>0){
    alert('Partes fallidas: '+Array.from(FALLIDAS).join(', '));
  }else{
    alert('Todas las partes OK');
  }
}

async function reintentarUno(idx){
  const totalParts = _TOTAL_PARTS || 0;
  if(!LAST_HEADER || LAST_ROWS.length===0){ alert('Primero usa "Subir en partes"'); return; }
  const start = (idx-1)*LAST_CHUNK;
  const slice = LAST_ROWS.slice(start, start+LAST_CHUNK);
  const blob = makeBlob(LAST_HEADER, slice, idx);
  const res = await postCSV(blob);
  appendRow(idx, res);
  _accTotals(res);
  if(res.ok) FALLIDAS.delete(idx); else FALLIDAS.add(idx);
  if(totalParts>0){
    // Recompute done as total - fallidas.size, since table may have been partially OK
    const done = totalParts - FALLIDAS.size;
    _setProgress(done, totalParts);
  }
}

async function reintentarFallidas(){
  if(FALLIDAS.size===0){ alert('No hay partes fallidas'); return; }
  for(const idx of Array.from(FALLIDAS)){
    await reintentarUno(idx);
  }
}
</script>
</body>
</html>
