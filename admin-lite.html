<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin Lite Plus — Importación por Partes</title>
<style>
:root{--b:#0b5fff;--ok:#0a8f3c;--err:#c62828;--bg:#fafbff;--card:#fff}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;color:#222}
header{background:var(--b);color:#fff;padding:14px 18px;display:flex;align-items:center;justify-content:space-between}
header h1{font-size:18px;margin:0}
main{max-width:1100px;margin:20px auto;padding:0 16px}
.card{background:var(--card);border-radius:12px;box-shadow:0 8px 28px rgba(11,30,80,.08);padding:16px;margin-bottom:16px}
.row{display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin:8px 0}
input[type="text"],input[type="number"],input[type="password"],input[type="url"]{padding:8px 10px;border:1px solid #d1d5db;border-radius:8px;min-width:180px}
input[type="file"]{padding:6px 0}
button{border:0;border-radius:10px;padding:10px 14px;background:var(--b);color:#fff;font-weight:600;cursor:pointer}
button.secondary{background:#e5e7eb;color:#111}
button.ghost{background:transparent;border:1px solid #d1d5db;color:#333}
button:disabled{opacity:.5;cursor:not-allowed}
table{width:100%;border-collapse:collapse}
th,td{font-size:13px;border-bottom:1px solid #eee;padding:8px;text-align:left}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;font-weight:700;font-size:11px}
.badge.ok{background:#e8f5e9;color:var(--ok)}
.badge.err{background:#ffebee;color:var(--err)}
.mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
</style>
</head>
<body>
<header><h1>Admin Lite Plus · Importación por Partes</h1></header>
<main>
  <div class="card">
    <h3>Conexión</h3>
    <div class="row">
      <label>API Base</label>
      <input id="apiBase" type="url" placeholder="https://backend-spainroom.onrender.com" />
      <label>Admin Key</label>
      <input id="adminKey" type="password" placeholder="********" />
    </div>
  </div>

  <div class="card">
    <h3>Archivo CSV</h3>
    <div class="row">
      <input type="file" id="csvfile" accept=".csv" />
      <label>Tamaño de parte</label>
      <input type="number" id="chunkSize" value="500" min="100" step="100" />
      <label>Espera entre partes (ms)</label>
      <input type="number" id="throttleMs" value="300" min="0" step="50" />
    </div>
    <div class="row">
      <button onclick="subirDirecto()">Subir directo</button>
      <button onclick="subirEnPartes()">Subir en partes</button>
      <button class="ghost" onclick="reintentarFallidas()">Reintentar fallidas</button>
    </div>
    <div class="row">
      <small>Consejo: usa partes de 500. Si un trozo falla, aparecerá en la tabla y podrás reintentarlo de forma individual.</small>
    </div>
  </div>

  <div class="card">
    <h3>Resultado</h3>
    <table>
      <thead>
        <tr><th>#</th><th>Estado</th><th>Insert.</th><th>Actual.</th><th>Errores</th><th>Mensaje</th><th>Acción</th></tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</main>

<script>
function val(id){return document.getElementById(id).value}
function api(){return (val('apiBase')||'').replace(/\\/$/,'')}
function key(){return val('adminKey')}

function appendRow(idx, data){
  const tb=document.getElementById('tbody');
  let tr=document.querySelector('tr[data-idx="'+idx+'"]');
  if(!tr){
    tr=document.createElement('tr');
    tr.dataset.idx=idx;
    tr.innerHTML='<td class="mono">'+idx+'</td>'
      +'<td class="mono status"></td>'
      +'<td class="mono ins"></td>'
      +'<td class="mono upd"></td>'
      +'<td class="mono errs"></td>'
      +'<td class="mono msg"></td>'
      +'<td><button class="ghost mono" onclick="reintentarUno('+idx+')">Reintentar</button></td>';
    tb.appendChild(tr);
  }
  tr.querySelector('.status').innerHTML = data.ok ? '<span class="badge ok">OK</span>' : '<span class="badge err">FALLO</span>';
  tr.querySelector('.ins').textContent = data.inserted ?? '';
  tr.querySelector('.upd').textContent = data.updated ?? '';
  tr.querySelector('.errs').textContent = data.errors ?? '';
  tr.querySelector('.msg').textContent = (data.message||'').slice(0,160);
}

async function postCSV(blob){
  const fd=new FormData(); fd.append('file', blob, 'municipios.csv');
  const r=await fetch(api()+'/api/admin/franquicia/ingest', { method:'POST', headers:{'X-Admin-Key': key()}, body: fd });
  const text = await r.text();
  let j=null; try{ j=JSON.parse(text) }catch(e){}
  if(r.ok && j && (j.ok===true || j.ok==="true")) return {ok:true, inserted:j.inserted||0, updated:j.updated||0, errors:j.errors||0, message:""};
  return {ok:false, inserted:j?.inserted||0, updated:j?.updated||0, errors:j?.errors||0, message:(j?.error || text)};
}

async function subirDirecto(){
  const f=document.getElementById('csvfile').files[0];
  if(!f){ alert('Selecciona un CSV'); return; }
  const res=await postCSV(f);
  appendRow('ALL', res);
}

let LAST_HEADER=null, LAST_ROWS=[], LAST_CHUNK=500, FALLIDAS=new Set();

function csvParse(text){
  const lines=text.split(/\\r?\\n/);
  const header=lines.shift();
  const rows=lines.filter(x=>x.trim()!=="");
  return [header, rows];
}

function makeBlob(header, rows, idx){
  const csv = [header, ...rows].join('\\n');
  return new Blob([csv], {type:'text/csv'});
}

async function subirEnPartes(){
  const f=document.getElementById('csvfile').files[0];
  if(!f){ alert('Selecciona un CSV'); return; }
  const t = await f.text();
  const [header, rows] = csvParse(t);
  LAST_HEADER = header; LAST_ROWS = rows;
  const chunk = parseInt(document.getElementById('chunkSize').value)||500;
  LAST_CHUNK = chunk;
  FALLIDAS.clear();
  document.getElementById('tbody').innerHTML='';

  const throttle = parseInt(document.getElementById('throttleMs').value)||0;
  let part=1;
  for(let i=0; i<rows.length; i+=chunk){
    const slice = rows.slice(i, i+chunk);
    const blob = makeBlob(header, slice, part);
    const res = await postCSV(blob);
    appendRow(part, res);
    if(!res.ok) FALLIDAS.add(part);
    part++;
    if(throttle>0) await new Promise(r=>setTimeout(r, throttle));
  }
  if(FALLIDAS.size>0){
    alert('Partes fallidas: '+Array.from(FALLIDAS).join(', '));
  }else{
    alert('Todas las partes OK');
  }
}

async function reintentarUno(idx){
  if(!LAST_HEADER || LAST_ROWS.length===0){ alert('Primero usa "Subir en partes"'); return; }
  const start = (idx-1)*LAST_CHUNK;
  const slice = LAST_ROWS.slice(start, start+LAST_CHUNK);
  const blob = makeBlob(LAST_HEADER, slice, idx);
  const res = await postCSV(blob);
  appendRow(idx, res);
  if(res.ok) FALLIDAS.delete(idx); else FALLIDAS.add(idx);
}

async function reintentarFallidas(){
  if(FALLIDAS.size===0){ alert('No hay partes fallidas'); return; }
  for(const idx of Array.from(FALLIDAS)){
    await reintentarUno(idx);
  }
}
</script>
</body>
</html>
